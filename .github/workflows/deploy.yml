name: Deploy SupabaseLocal

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Local Server
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cat <<EOF > .env
          # Secrets
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          ANON_KEY=${{ secrets.ANON_KEY }}
          SERVICE_ROLE_KEY=${{ secrets.SERVICE_ROLE_KEY }}
          DASHBOARD_USERNAME=${{ secrets.DASHBOARD_USERNAME }}
          DASHBOARD_PASSWORD=${{ secrets.DASHBOARD_PASSWORD }}
          PG_META_CRYPTO_KEY=f69f2e3c4d5e6f7a8b9c0d1e2f3a4b5c
          
          # Database
          POSTGRES_HOST=db
          POSTGRES_DB=postgres
          POSTGRES_PORT=5432
          
          # API Gateway
          KONG_HTTP_PORT=8100
          KONG_HTTPS_PORT=8143
          
          # Auth & API URLs (using SERVER_IP secret)
          SERVER_IP=${{ secrets.SERVER_IP }}
          SUPABASE_PUBLIC_URL=http://${{ secrets.SERVER_IP }}:8100
          API_EXTERNAL_URL=http://${{ secrets.SERVER_IP }}:8100
          SITE_URL=http://${{ secrets.SERVER_IP }}:5173
          ADDITIONAL_REDIRECT_URLS=http://${{ secrets.SERVER_IP }}:3000,http://localhost:5173,http://localhost:3000
          
          # Auth Configuration
          JWT_EXPIRY=3600
          DISABLE_SIGNUP=false
          ENABLE_EMAIL_SIGNUP=true
          ENABLE_ANONYMOUS_USERS=false
          ENABLE_EMAIL_AUTOCONFIRM=true
          
          # Email Settings (Defaults)
          SMTP_ADMIN_EMAIL=admin@example.com
          SMTP_HOST=supabase-mail
          SMTP_PORT=2500
          SMTP_USER=fake_mail_user
          SMTP_PASS=fake_mail_password
          SMTP_SENDER_NAME=TriathlonHelper
          MAILER_URLPATHS_CONFIRMATION="/auth/v1/verify"
          MAILER_URLPATHS_INVITE="/auth/v1/verify"
          MAILER_URLPATHS_RECOVERY="/auth/v1/verify"
          MAILER_URLPATHS_EMAIL_CHANGE="/auth/v1/verify"
          
          # PostgREST
          PGRST_DB_SCHEMAS=public,storage,graphql_public
          
          # Studio
          STUDIO_DEFAULT_ORGANIZATION=Triathlon
          STUDIO_DEFAULT_PROJECT=TriathlonHelper
          IMGPROXY_ENABLE_WEBP_DETECTION=true
          EOF

      - name: Deploy with Docker Compose
        run: |
          docker compose up -d --remove-orphans
