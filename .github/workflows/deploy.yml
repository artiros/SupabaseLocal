name: Deploy SupabaseLocal

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create .env file
        run: |
          echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "ANON_KEY=${{ secrets.ANON_KEY }}" >> .env
          echo "SERVICE_ROLE_KEY=${{ secrets.SERVICE_ROLE_KEY }}" >> .env
          echo "DASHBOARD_USERNAME=${{ secrets.DASHBOARD_USERNAME }}" >> .env
          echo "DASHBOARD_PASSWORD=${{ secrets.DASHBOARD_PASSWORD }}" >> .env
          # Add other necessary env vars from secrets or defaults
          echo "POSTGRES_PORT=5433" >> .env
          echo "POSTGRES_DB=postgres" >> .env
          echo "POSTGRES_HOST=db" >> .env
          echo "KONG_HTTP_PORT=8000" >> .env
          echo "KONG_HTTPS_PORT=8443" >> .env
          echo "STUDIO_DEFAULT_ORGANIZATION=Default Organization" >> .env
          echo "STUDIO_DEFAULT_PROJECT=Default Project" >> .env
          echo "SUPABASE_PUBLIC_URL=http://${{ secrets.SERVER_IP }}:8000" >> .env
          echo "SITE_URL=http://${{ secrets.SERVER_IP }}:3000" >> .env
          echo "API_EXTERNAL_URL=http://${{ secrets.SERVER_IP }}:8000" >> .env

      - name: Copy files via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "docker-compose.yml,.env,volumes/api/kong.yml"
          target: "~/supabase"

      - name: Execute deployment via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            mkdir -p ~/supabase/volumes/db/data
            mkdir -p ~/supabase/volumes/storage
            mkdir -p ~/supabase/volumes/api
            cd ~/supabase
            # Pull generic images (postgres, studio, etc)
            docker-compose pull
            # Restart services with new config
            docker-compose up -d --remove-orphans
