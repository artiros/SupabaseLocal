name: Deploy SupabaseLocal

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Local Server
    runs-on: self-hosted
    environment: Supabase
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create .env file
        env:
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          ANON_KEY: ${{ secrets.ANON_KEY }}
          SERVICE_ROLE_KEY: ${{ secrets.SERVICE_ROLE_KEY }}
          DASHBOARD_USERNAME: ${{ secrets.DASHBOARD_USERNAME }}
          DASHBOARD_PASSWORD: ${{ secrets.DASHBOARD_PASSWORD }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
        run: |
          if [ -z "$POSTGRES_PASSWORD" ]; then echo "‚ùå POSTGRES_PASSWORD secret is empty!" && exit 1; fi
          
          cat <<EOF > .env
          # Secrets (Injected from GitHub)
          POSTGRES_PASSWORD=$POSTGRES_PASSWORD
          JWT_SECRET=$JWT_SECRET
          ANON_KEY=$ANON_KEY
          SERVICE_ROLE_KEY=$SERVICE_ROLE_KEY
          DASHBOARD_USERNAME=$DASHBOARD_USERNAME
          DASHBOARD_PASSWORD=$DASHBOARD_PASSWORD
          PG_META_CRYPTO_KEY=REPLACE_ME_PG_META_CRYPTO_KEY_32_CHARS
          
          # Database
          POSTGRES_HOST=db
          POSTGRES_DB=postgres
          POSTGRES_PORT=5432
          
          # API Gateway
          KONG_HTTP_PORT=8100
          KONG_HTTPS_PORT=8143
          
          # Auth & API URLs
          SERVER_IP=$SERVER_IP
          SUPABASE_PUBLIC_URL=http://$SERVER_IP:8100
          API_EXTERNAL_URL=http://$SERVER_IP:8100
          SITE_URL=http://$SERVER_IP:7001
          ADDITIONAL_REDIRECT_URLS=http://$SERVER_IP:7001,http://localhost:5173,http://localhost:3000
          
          # Configuration
          JWT_EXPIRY=3600
          DISABLE_SIGNUP=false
          ENABLE_EMAIL_SIGNUP=true
          ENABLE_ANONYMOUS_USERS=false
          ENABLE_EMAIL_AUTOCONFIRM=true
          
          # Email Settings
          SMTP_ADMIN_EMAIL=admin@example.com
          SMTP_HOST=supabase-mail
          SMTP_PORT=2500
          SMTP_USER=fake_mail_user
          SMTP_PASS=fake_mail_password
          SMTP_SENDER_NAME=TriathlonHelper
          MAILER_URLPATHS_CONFIRMATION="/auth/v1/verify"
          MAILER_URLPATHS_INVITE="/auth/v1/verify"
          MAILER_URLPATHS_RECOVERY="/auth/v1/verify"
          MAILER_URLPATHS_EMAIL_CHANGE="/auth/v1/verify"
          
          # PostgREST
          PGRST_DB_SCHEMAS=public,storage,graphql_public
          
          # Phone Auth
          ENABLE_PHONE_SIGNUP=false
          ENABLE_PHONE_AUTOCONFIRM=false
          
          # Studio
          STUDIO_DEFAULT_ORGANIZATION=Triathlon
          STUDIO_DEFAULT_PROJECT=TriathlonHelper
          IMGPROXY_ENABLE_WEBP_DETECTION=true
          EOF

      - name: Prepare Config and Permissions
        env:
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          mkdir -p volumes/db/data
          mkdir -p volumes/storage
          mkdir -p volumes/api
          mkdir -p volumes/logs
          
          # Inject the correct password into roles.sql from the secret
          # This ensures the DB roles match the services' expectations
          # Using environment variable for sed to handle complex passwords
          sed -i "s#REPLACE_ME_PASSWORD#$POSTGRES_PASSWORD#g" volumes/db/roles.sql || true
          
          # Use docker to fix permissions
          # 999 is the UID for the postgres user in the supabase image
          docker run --rm -v $PWD/volumes:/target alpine sh -c "chmod -R 777 /target && chown -R 999:999 /target/db"

      - name: Deploy with Docker Compose
        env:
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          ANON_KEY: ${{ secrets.ANON_KEY }}
          SERVICE_ROLE_KEY: ${{ secrets.SERVICE_ROLE_KEY }}
          DASHBOARD_USERNAME: ${{ secrets.DASHBOARD_USERNAME }}
          DASHBOARD_PASSWORD: ${{ secrets.DASHBOARD_PASSWORD }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
        run: |
          echo "Current working directory: $(pwd)"
          echo "Checking directory status..."
          ls -la
          echo "Starting stack..."
          docker compose -f ${{ github.workspace }}/docker-compose.yml up -d --remove-orphans
          
      - name: Show Logs on Failure
        if: failure()
        run: |
          echo "=== DB Logs ==="
          docker compose -f ${{ github.workspace }}/docker-compose.yml logs db || true
          echo "=== All Services Status ==="
          docker compose -f ${{ github.workspace }}/docker-compose.yml ps
